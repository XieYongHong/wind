<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>智慧风场</title>
    <link rel="stylesheet" href="css/index.css">
</head>

<body>
    <div class="content">
        <div id="map"></div>
        <div class="legend">
            <div>
                <img src="/img/WT_Normal.png" class="work-order">
                <span>无工单</span>
            </div>
            <div>
                <img src="/img/WT_Warning.png" class="work-order warning">
                <span>预警工单</span>
            </div>
            <div>
                <img src="/img/WT_Erro.png" class="work-order error">
                <span>故障工单</span>
            </div>
            <div>
                <img src="/img/WT_Maintain.png" class="work-order maintain">
                <span>运维工单</span>
            </div>
            <div>
                <img src="/img/WT_Offline.png" class="work-order">
                <span>离线工单</span>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=gSopVcsvgn0uSpjMBbR3nhvBvkYb1W70"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/map.js"></script>
    <script>
        var map
        var getCarList = function() {
            var ws = new WebSocket('ws://localhost:8081/getCarList')
            ws.onopen = function(){
                console.log('连接成功');
            }
            ws.onmessage = function(data) {
                console.log(data.data);
                if(data.data){
                    var arr = JSON.parse(data.data)
                    var datas = []
                    for(var i=0;i<arr.length;i++){
                        if(arr[i].lao){
                            var lnglat = arr[i].lao.split('/')
                            var obj = {
                                iconUrl: arr[i].st == 'off' ? '/img/car_stop.png' :'/img/car_move.gif',
                                w: 42,
                                h: 31,
                                longitude: lnglat[1],
                                latitude: lnglat[0],
                                anchor: [21, 15],
                                id: arr[i].mid,
                                type: 'car'
                            }
                            console.log(obj);
                            datas.push(obj)
                        }
                    }
                    map.removeMarkerType('car')  
                    map.addMarker(datas)
                }
            }
            ws.onclose = function(){
                console.log('连接中断');
            }
        }
        var getMarkers = function(id){
            if(id)
            $.ajax({
                type: "get",
                url: "/getWorkOrder/"+id,
                data: {},
                success: function (data) {
                    if(data.code == 200){
                        var datas = data.data
                        var arr = []
                        if(datas.length){
                            datas.forEach(function(a){
                                a.iconUrl = '/img/Farm.png'
                                a.w = 52
                                a.h = 49
                                a.anchor = [25, 25]
                                if(a.type == 1){
                                    switch (a.status) {
                                        case 1:
                                            a.iconUrl = '/img/WT_Normal.png'
                                            break;
                                        case 2:
                                            a.iconUrl = '/img/WT_Erro.png'
                                            break;
                                        case 3:
                                            a.iconUrl = '/img/WT_Warning.png'
                                            break;
                                        case 4:
                                            a.iconUrl = '/img/WT_Maintain.png'
                                            break;
                                        case 0:
                                            a.iconUrl = '/img/WT_Offline.png'
                                            break;
                                    }
                                    a.w = 36
                                    a.h = 70
                                    a.anchor = [18, 68]
                                    map.addOverlay(new ComplexCustomOverlay(a, map))
                                }else{
                                    arr.push(a)
                                }
                            });
                            map.addMarker(arr)
                        }
                    }
                }
            });
        }

        var RealTimeMarker = function() {
            var ws = new WebSocket('ws://localhost:8081/updateturbine')
            ws.onopen = function(){
                console.log('连接成功');
            }
            ws.onmessage = function(data) {
                console.log(data);
                if(data.data){
                    var obj = JSON.parse(data.data)
                    var datas = obj.datas
                    if(map){
                        var list = map._map.getOverlays()
                        for(var i=0;i<datas.length; i++){
                            for(var j=0;j<list.length;j++){
                                if(list[j].data){
                                    if(datas[i].id == list[j].data.id){
                                        var status = datas[i].status
                                        list[j].data.time = datas[i].time
                                        switch(status) {
                                            case 1:
                                                list[j].data.iconUrl = '/img/WT_Normal.png'
                                            break;
                                            case 2:
                                                list[j].data.iconUrl = '/img/WT_Erro.png'
                                                break;
                                            case 3:
                                                list[j].data.iconUrl = '/img/WT_Warning.png'
                                                break;
                                            case 4:
                                                list[j].data.iconUrl = '/img/WT_Maintain.png'
                                                break;
                                            case 0:
                                                list[j].data.iconUrl = '/img/WT_Offline.png'
                                                break;
                                        }
                                        map._map.removeOverlay(list[j])
                                        map.addOverlay(new ComplexCustomOverlay(list[j].data, map))
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            ws.onclose = function(){
                console.log('连接中断');
            }
        }

        function init(){
            var url = location.search.substr(1)
            var arr = url.split('&')
            var d = {}
            for(var i=0; i<arr.length; i++){
                var _arr = arr[i].split('=')
                d[_arr[0]] = _arr[1]
            }
            map = new Map({
                dom: 'map',
                zoom: 14,
                center: [d.lng, d.lat]
            })
            map.init()
            getCarList()
            getMarkers(d.id)
            RealTimeMarker()
        }
        init()
    </script>
</body>

</html>